<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
  xmlns:py="http://genshi.edgewall.org/"
  xmlns:xi="http://www.w3.org/2001/XInclude">

<xi:include href="master.html" />

<head>
  <meta content="text/html; charset=UTF-8" http-equiv="content-type" py:replace="''"/>
  <title>${title()}</title>
</head>

<body py:with="cluster_data = tmpl_context.cluster.get_model();
               cluster_status = tmpl_context.cluster.get_status()">

  <script type="text/javascript" src="/js/fence.js"></script>

  <form action="${tg.url(fences_cmd)}" method="post">
  <div class="sectionblock">
  <xi:include href="submenu.html"/>
  <div id="toolbar">
    <a href="#" class="toolbar_button" id="tb_add" onclick="$('#create_fencedev_dialog').dialog('open')">Add</a>
    <input type="submit" name="MultiAction" value="${_('Delete')}" class="toolbar_button MultiAction" id="tb_delete" disabled="disabled"/>
  </div>

  <!--! OVERVIEW SECTION. -->
  <div id="overview">
    <table id="fence_tlist" class="maintable">
      <thead>
        <tr>
          <th class="checkbox"></th>
          <th class="main_id">Name</th>
          <th class="fence_tlist_type">Fence Type</th>
          <th class="fence_tlist_members">Nodes Using</th>
          <th class="fence_tlist_ip">Hostname</th>
        </tr>
      </thead>
      <tbody>
        <!--! List all the fences. -->
        <py:if test="cluster_data">
        <tr py:for="i, fence_data in enumerate(cluster_data.getFenceDevices())"
            py:with="entity_name = fence_data.getName();
                     identifier = entity_name;
                     local_fence = fence_data.isShared() != True;
                     nodes_using = cluster_data.getNodesUsingFence(entity_name)"
            py:attrs="entity_name==name and {'class': 'chosen'} or (not i%2 and {'class': 'even'} or None)">
          <td class="checkbox">
            <input type="checkbox" name="${identifier}"
                onclick="update_multi_action(this)" class="MultiActionItem"/>
          </td>
          <!--! If the fence is shared, display appropriate icon. -->
          <td class="main_id"><a href="${tg.url(base_url + '/' + entity_name)}">${entity_name}</a></td>
          <td class="fence_tlist_type">${fence_data.getPrettyName()}</td>
          <!--! Branch according to whether the fence is local or shared. -->
          <py:choose test="local_fence">
          <!--! 1) Local. -->
          <td py:when="True" class="fence_tlist_members"
              py:with="local_node = len(nodes_using) > 0 and nodes_using[0] or None">
            <py:choose test="cluster_status and cluster_status.nodes and local_node and cluster_status.nodes.get(local_node.getName()).clustered">
            <span py:when="'true'" class="entity_ok">${local_node.getName()}</span>
            <span py:when="'false'" class="entity_fail">${local_node.getName()}</span>
            <span py:when="''" class="entity_unknown">${local_node.getName()}</span>
            </py:choose>
          </td>
          <!--! 2) Shared. -->
          <td py:otherwise="" class="fence_tlist_members">${len(nodes_using)}</td>
          </py:choose>
          <td class="fence_tlist_ip">${fence_data.getAttribute('ipaddr')}</td>
        </tr>
        </py:if>
      </tbody>
    </table>
  </div>
  </div>
  </form>

  <div id="bad_conf" class="sectionblock" py:if="cluster_data and cluster_data.errors">
      <img alt="Errors parsing cluster.conf XML" src="/images/exclamation.png"/>
      <span class="error">Luci was not able to parse this cluster's configuration without errors. Your configuration may be invalid.</span>

      <py:if test="cluster_data.errmsg">
        The following errors occurred:<br/>
        <ul>
            <li py:for="m in cluster_data.errmsg">${m}</li>
        </ul>
      </py:if>
      <span class="error">
        Fixing this may require you to log into one of the cluster nodes, edit the cluster.conf file to fix the error, and propagate the new configuration.
      </span>
  </div>

  <xi:include href="fence_devices.html" />
  ${fence_device_container()}

  <!--! DETAILS SECTION. -->
  <div class="sectionblock sectionblock2">
  <div id="details" py:choose="name">

    <py:when test="None">
    <div id="details_header">
      <div id="not_selected">
        <py:if test="cluster_data">
            <py:choose test="len(cluster_data.getFenceDevices())">
                <py:when test="0">No item to display</py:when>
                <py:otherwise>Select an item to view details</py:otherwise>
            </py:choose>
        </py:if>
        <py:if test="not cluster_data">
            No nodes from this cluster could be contacted. The status of this cluster is unknown.
        </py:if>
      </div>
    </div>
    </py:when>

    <py:otherwise py:with="details = cluster_data.getFenceDeviceByName(name)">

    <!--! DETAILS - header section. -->
    <div id="details_header">
      <h3 py:content="name">Fence A</h3>
      <div id="details_header_buttons">
        <a href="${tg.url(fences_cmd + '?command=Delete' + '&amp;name=' + name)}" id="dh_delete" title="delete"><span class="hide">delete</span></a>
      </div>
      <span class="details_header_info_label">Type</span> <span class="details_header_info">${details.getPrettyName()}</span>
    </div>

    <!--! DETAILS - hostname/IP/port section. -->
    <div class="details_section">
        <form name="create_fence_device" method="post" action="${tg.url(fences_cmd + '?command=Update')}">
        <?python
            try:
                agent_type = details.getAgentType()
                agent_fn = eval(agent_type)
            except NameError:
                agent_fn = eval('fence_unknown')
        ?>
        ${agent_fn(details, 0)}
        <input py:if="expertMode" type="hidden" name="expert_mode" value="1"/>
        <input type="submit" class="button formsubmit blue" value="Apply"/>
        </form>
      <ul id="fence_details_list">
      </ul>
    </div>

    <!--! DETAILS - nodes section. -->
    <div class="details_section">
      <!--! <a href="" class="float_button">Manage Nodes</a> -->
      <h4>Nodes</h4>
      <div class="details_inner">
        <table id="fence_tnodes" class="detailstable">
          <thead>
            <tr class="grid_row">
              <th class="icon">!</th>
              <th class="fence_tnodes_name">Node Name</th>
              <th class="fence_tnodes_status">Status</th>
            </tr>
          </thead>
          <tbody>
            <!--! List all the nodes using the current fence device -->
            <tr py:for="node in cluster_data.getNodesUsingFence(details.getName())" class="grid_row">
              <py:with vars="cur_nodename = node.getName();
                             cur_nodeurl = '%s%s' % (tmpl_context.cluster_url, cur_nodename)">
              <!--! Branch according to the status of the node. -->
              <py:choose test="cluster_status and cluster_status.nodes and cluster_status.nodes.get(cur_nodename).clustered">
              <!--! 1) Node is active. -->
              <py:when test="'true'">
              <td class="icon"></td>
              <td class="fence_tnodes_name">
                <span class="entity_ok"><a href="${cur_nodeurl}">${cur_nodename}</a></span>
              </td>
              <td class="fence_tnodes_status">${_('OK')}</td>
              </py:when>
              <!--! 2) Node is inactive. -->
              <py:when test="'false'">
              <td class="icon">
                <img src="${tg.url('/images/exclamation.png')}" alt="Node has a problem." />
              </td>
              <td class="fence_tnodes_name">
                <span class="entity_fail"><a href="${cur_nodeurl}">${cur_nodename}</a></span>
              </td>
              <td class="fence_tnodes_status">Not a cluster member</td>
              </py:when>
              <!--! 3) Status of the node is unknown. -->
              <py:when test="false">
              <td class="icon">
                <img src="${tg.url('/images/question.png')}" alt="Status of the node is unknown." />
              </td>
              <td class="fence_tnodes_name">
                <span class="entity_unknown"><a href="${cur_nodeurl}">${cur_nodename}</a></span>
              </td>
              <td class="fence_tnodes_status">Status unknown</td>
              </py:when>
              </py:choose>
              </py:with>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    </py:otherwise>
  </div>
  </div>

  <div class="hidden">
  <div id="create_fencedev_dialog">
    <form name="create_fence_device" method="post" action="${tg.url(fences_cmd + '?command=Create')}">
        ${fence_device_select(None, 'fence_form_area')}
        <div id="fence_form_area" />
        <div class="row">
        <input py:if="expertMode" type="hidden" name="expert_mode" value="1"/>
        <input type="submit" value="Submit" class="button formsubmit blue" />
        <input type="button" class="button formsubmit silver" value="Cancel"
            onclick="$('#create_fencedev_dialog').dialog('close');reset_form(this.form)" />
        </div>
    </form>
  </div>
  </div>
</body>
</html>
